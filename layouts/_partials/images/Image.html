{{/* TODO: Buat Module Image Processing
  - Mungkin Proyek Mendatang Buat Modul Khusus Image Processing

  @params:
  - "src"     | [string]  -> @example: "images/item.png"
  - "alt"     | [string]  -> @example: "Image Product"
  - "class"   | [string]  -> @example: "border-2 mx-auto p-2"
  - "base"    | [int]     -> @example: 300
  - "sizes"   | [string]  -> @example: (slice "400x" "800x" "1200x")
  - "loading" | default lazy | eager
  - "mode"    | default none | square | portrait | landscape

  @example:
  Untuk Gambar Local taruh di assets & Untuk Remote Bebas Tapi Kemungkinan Error saat gambar gagal di ambil.

  1. Default
  {{ partial "images/Image" (dict "src" "img/photo.jpg")
}}

2. Custom Resize
{{ partial "images/Image" (dict
  "src" "img/banner.jpg"
  "sizes" (slice "400x" "800x" "1200x")
  )
}}

3. Square (Auto Mode)
{{ partial "images/Image" (dict
  "src" "img/avatar.jpg"
  "mode" "square"
  "base" 300
  )
}}

4. Portrait
{{ partial "images/Image" (dict
  "src" "img/poster.jpg"
  "mode" "portrait"
  "base" 300
  )
}}

5. Landscape
{{ partial "images/Image" (dict
  "src" "img/hero.jpg"
  "mode" "landscape"
  "base" 300
  )
}}
*/}}
{{- $srcParam := .src }}
{{- $alt := .alt | default "Image" }}
{{- $title := .title }}
{{- $loading := .loading | default "lazy" }}
{{- $class := .class }}
{{- $mode := .mode | default "" }}
{{- $base := .base | default 300 }}
{{- $sizesParam := .sizes }}
{{- $process := .process | default "resize" }}

{{/* Default responsive sizes */}}
{{- $defaultSizes := slice "320x" "640x" "960x" "1280x" "1600x" }}

{{/* Override sizes by mode */}}
{{- if $mode }}
  {{- if eq $mode "square" }}
    {{- $sizesParam = slice
      (printf "%dx%d" $base $base)
      (printf "%dx%d" (mul $base 2) (mul $base 2))
      (printf "%dx%d" (mul $base 3) (mul $base 3))
    }}
  {{- else if eq $mode "portrait" }}
    {{- $sizesParam = slice
      (printf "%dx%d" $base (mul $base 4))
      (printf "%dx%d" (mul $base 2) (mul $base 8))
    }}
  {{- else if eq $mode "landscape" }}
    {{- $sizesParam = slice
      (printf "%dx%d" (mul $base 4) $base)
      (printf "%dx%d" (mul $base 8) (mul $base 2))
    }}
  {{- end }}
{{- end }}

{{- $sizes := cond $sizesParam $sizesParam $defaultSizes }}

{{/* Get image */}}
{{- $image := "" }}
{{- if strings.HasPrefix $srcParam "http" }}
  {{- $image = resources.GetRemote $srcParam }}
{{- else }}
  {{- $image = resources.Get $srcParam }}
{{- end }}

{{/* Generate variants */}}
{{- $variants := slice }}
{{- range $sizes }}
  {{- $img := "" }}

  {{- if eq $process "crop" }}
    {{- $img = $image.Crop . }}
  {{- else if eq $process "fill" }}
    {{- $img = $image.Fill . }}
  {{- else if eq $process "fit" }}
    {{- $img = $image.Fit . }}
  {{- else if eq $process "smart" }}
    {{- $img = $image.Fill (printf "%s smart" .) }}
  {{- else }}
    {{- $img = $image.Resize . }}
    {{/* default */}}
  {{- end }}

  {{- $variants = $variants | append $img }}
{{- end }}

{{/* Largest version for fallback */}}
{{- $large := index $variants (sub (len $variants) 1) }}

{{/* Build srcset */}}
{{- $srcset := slice }}
{{- range $variants }}
  {{- $srcset = $srcset | append (printf "%s %dw" .RelPermalink .Width) }}
{{- end }}

{{/* Build srcset webp */}}
{{- $srcsetWebp := slice }}
{{- range $variants }}
  {{- $webp := .Process "webp" }}
  {{- $srcsetWebp = $srcsetWebp | append (printf "%s %dw" $webp.RelPermalink .Width) }}
{{- end }}


<picture>
  <source
    type="image/webp"
    srcset="{{ delimit $srcsetWebp ", " }}"
    sizes="100vw"
  />
  <source srcset="{{ delimit $srcset ", " }}" sizes="100vw" />
  <img
    src="{{ $large.RelPermalink }}"
    alt="{{ $alt }}"
    width="{{ $large.Width }}"
    height="{{ $large.Height }}"
    loading="{{ $loading }}"
    decoding="async"
    {{ with $class }}class="{{ . }}"{{ end }}
    {{ with $title }}title="{{ . }}"{{ end }}
  />
</picture>
