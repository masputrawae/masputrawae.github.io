{{ define "main" }}
  <div class="min-h-screen mx-auto max-w-3xl">
    <div class="prose prose-invert prose-neutral max-w-full text-center">
      <form onsubmit="return false;">
        <label for="search-input" class="mb-4 block">
          <span class="text-5xl font-bold text-white text-shadow-sm/100">Pencarian</span>
        </label>
        <input
          type="search"
          name="search"
          id="search-input"
          placeholder="Ketik di sini untuk mencari..."
          class="w-full max-w-md rounded-lg border border-neutral-700 px-4 py-2 focus:ring-2 focus:ring-amber-500 focus:outline-none"
        />
      </form>
    </div>
    <div id="results" hidden class="mt-8"></div>
  </div>

{{ partial "assets/jsBuild" (dict "file" "js/fuse.js" "jsBuild" false ) }}
<script>
class SearchHandler {
  constructor() {
    this.searchInput = document.querySelector("#search-input");
    this.resultsPanel = document.querySelector("#results");
    this.isInitialized = false;

    this.fuse = null;
    this.store = [];
    this.debounceTimer = null;
  }

  init() {
    if (!this.searchInput || !this.resultsPanel) {
      console.error("Search elements not found");
      return;
    }

    this.initializeSearch();
  }

  async initializeSearch() {
    try {
      const searchUrl = `{{ "search.json" | relURL }}`;
      if (!searchUrl) throw new Error("Search URL not found");

      await this.loadSearchIndex(searchUrl);
      this.setupEventListeners();
      this.handleInitialQuery();

      this.isInitialized = true;
    } catch (error) {
      console.error("Search initialization failed:", error);
      this.showError("Search is currently unavailable");
    }
  }

  async loadSearchIndex(searchUrl) {
    const response = await fetch(searchUrl);
    if (!response.ok) throw new Error(`Failed to fetch search index: ${response.status}`);

    this.store = await response.json();

    this.fuse = new Fuse(this.store, {
      keys: [
        { name: "title", weight: 0.4 },
        { name: "tags", weight: 0.3 },
        { name: "category", weight: 0.1 },
        { name: "description", weight: 0.1 },
        { name: "date", weight: 0.1 },
      ],
      threshold: 0.3,
      includeMatches: true,
      minMatchCharLength: 2,
      useExtendedSearch: true,
    });
  }

  setupEventListeners() {
    this.debouncedHandleSearch = this.debounce(this.handleSearch.bind(this), 300);
    this.searchInput.addEventListener("input", this.debouncedHandleSearch);

    const form = this.searchInput.closest("form");
    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        this.handleSearch();
      });
    }

    this.searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        this.clearSearch();
        this.searchInput.blur();
      }
    });
  }

  handleInitialQuery() {
    const params = new URLSearchParams(window.location.search);
    const initialQuery = params.get("query");

    if (initialQuery) {
      this.searchInput.value = initialQuery.trim();
      this.handleSearch();
    }
  }

  handleSearch() {
    const query = this.searchInput.value.trim();

    if (!this.fuse) {
      console.error("Fuse.js not initialized");
      return;
    }

    this.updateSEO(query);

    const results = query.length >= 2 ? this.fuse.search(query) : [];
    this.displayResults(results, query);
  }

  updateSEO(query) {
    const params = new URLSearchParams(window.location.search);

    if (query) params.set("query", query);
    else params.delete("query");

    const newUrl = `${location.pathname}${params.toString() ? `?${params.toString()}` : ""}`;
    history.replaceState({}, "", newUrl);
    this.updateCanonicalUrl(newUrl);

    if (query.length > 0) this.updateMetaTags(query);
  }

  updateCanonicalUrl(url) {
    let canonical = document.querySelector('link[rel="canonical"]');
    if (!canonical) {
      canonical = document.createElement("link");
      canonical.rel = "canonical";
      document.head.appendChild(canonical);
    }
    canonical.href = url;
  }

  updateMetaTags(query) {
    const description = `Pencarian Untuk "${query}" di {{ site.Title }}`;
    document.title = `Pencarian ${query} di {{ site.Title }}`;

    const metaTags = [
      'meta[name="description"]',
      'meta[property="og:description"]',
      'meta[name="twitter:description"]',
      'meta[itemprop="description"]',
    ];

    metaTags.forEach((selector) => {
      const meta = document.querySelector(selector);
      if (meta) meta.setAttribute("content", description);
    });

    this.updateStructuredData(query, description);
  }

  updateStructuredData(query, description) {
    const ldJson = document.querySelector('script[type="application/ld+json"]');
    if (!ldJson) return;

    try {
      const data = JSON.parse(ldJson.textContent);
      data.headline = description;
      data.description = description;
      data.url = window.location.href;
      ldJson.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      console.warn("Failed to update structured data:", error);
    }
  }

  displayResults(results, query) {
    if (!query || query.length < 1) return this.clearSearch();
    if (results.length === 0) return this.showNoResults(query);

    this.resultsPanel.innerHTML = this.generateResultsHTML(results);
    this.resultsPanel.hidden = false;
  }

  generateResultsHTML(results) {
    return results.map((result) => this.generateResultItemHTML(result.item)).join("");
  }

  generateResultItemHTML(item) {
    const imageUrl = item.image || "";
    const dateFormatted = this.formatDate(item.date);

    return `
      <div class="group border-neutral-700 ${imageUrl ? "md:grid-cols-[12rem_minmax(0,1fr)] md:items-center md:gap-8" : ""} -mt-px grid border-y py-10">
        ${imageUrl ? this.generateImageHTML(imageUrl) : ""}
        <div class="grid gap-4">
          ${dateFormatted ? this.generateDateHTML(item.date, dateFormatted) : ""}
          <h2 class="text-2xl font-semibold text-white">
            <a href="${this.escapeHTML(item.href)}">${this.escapeHTML(item.title)}</a>
          </h2>
          ${item.description ? this.generateDescriptionHTML(item.description) : ""}
          ${this.generateReadMoreHTML(item.href, item.title)}
        </div>
      </div>
    `;
  }

  generateImageHTML(imageUrl) {
    return `
      <div class="aspect-square size-48 overflow-hidden shadow-sm rounded-sm max-md:hidden">
        <img src="${this.escapeHTML(imageUrl)}" class="size-full object-cover" loading="lazy" alt="">
      </div>
    `;
  }

  generateDateHTML(date, formattedDate) {
    return `<time datetime="${date}" class="text-neutral-400 text-sm font-medium">${formattedDate}</time>`;
  }

  generateDescriptionHTML(description) {
    return `<p class="line-clamp-3 text-sm text-neutral-400">${this.escapeHTML(description)}</p>`;
  }

  generateReadMoreHTML(href, title) {
    return `
      <a 
        href="${this.escapeHTML(href)}" 
        class="group-hover:text-amber-400 font-semibold text-white transition duration-500"
      >
        <span>Lihat Selengkapnya</span> 
        <span class="sr-only">${this.escapeHTML(title)}</span>
      </a>
    `;
  }

  formatDate(dateString) {
    if (!dateString) return "";

    try {
      return new Date(dateString).toLocaleDateString("en-US", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    } catch {
      return "";
    }
  }

  showNoResults(query) {
    this.resultsPanel.innerHTML = `
      <div class="py-10 text-center text-neutral-400">
        Tidak Ditemukan Hasil Untuk: "${this.escapeHTML(query)}"
      </div>
    `;
    this.resultsPanel.hidden = false;
  }

  showError(message) {
    this.resultsPanel.innerHTML = `<div class="py-10 text-center">${this.escapeHTML(message)}</div>`;
    this.resultsPanel.hidden = false;
  }

  clearSearch() {
    this.resultsPanel.innerHTML = "";
    this.resultsPanel.hidden = true;
  }

  escapeHTML(unsafe) {
    if (!unsafe) return "";
    return unsafe.toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  debounce(func, wait) {
    return (...args) => {
      clearTimeout(this.debounceTimer);
      this.debounceTimer = setTimeout(() => func.apply(this, args), wait);
    };
  }

  search(query) {
    if (!this.isInitialized) {
      console.warn("Search handler not initialized");
      return;
    }
    this.searchInput.value = query;
    this.handleSearch();
  }

  destroy() {
    if (this.debounceTimer) clearTimeout(this.debounceTimer);
    if (this.debouncedHandleSearch) this.searchInput.removeEventListener("input", this.debouncedHandleSearch);

    const form = this.searchInput.closest("form");
    if (form) form.removeEventListener("submit", this.handleSearch);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  window.searchHandler = new SearchHandler();
  window.searchHandler.init();
});
</script>
{{ end }}